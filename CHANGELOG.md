# Feature History

- 001-restaurant-wishlist: Migrated from Dexie.js (IndexedDB) to Supabase (Postgres + Kakao OAuth). Dropped offline/guest mode. All data is cloud-synced per user.
- 002-integrate-search-tabs: Merged Search & Map tabs into unified search+map page with bottom sheet, auto-fit bounds, marker interaction.
- 003-merge-wishlist-categories: Replaced flat wishlist with auto-categorized accordion view (grouped by Kakao subcategory). Removed By Menu tab. Improved auth callback error handling and login UX.
- 004-smart-search: Added semantic query expansion (12 food category dictionary) and distance-sorted results. Searching "chicken" now finds KFC, BBQ, etc. Results sorted nearest-first with distance labels. Uses Kakao API `sort=distance` + `radius=5000m`. Parallel queries via `Promise.allSettled` with dedup.
- 005-remove-map-tab: Removed standalone Map tab (redundant with unified search+map page). Added `/map` → `/search` permanent redirect. Cleaned up dead `searchByBounds` code.
- 006-viewport-search: Replaced fixed 5km-radius/45-result search with viewport-based search. "Search this area" button on pan/zoom, full pagination (up to 3 pages per term), 300-result cap. Error toast with retry on failure.
- 007-social-follow: Added social follow system — user search, follow/unfollow, profile pages (`/users`, `/users/[id]`), and public wishlist viewing. New DB tables: `profiles` and `follows`. `restaurants` RLS updated from per-user to all-authenticated-users.
- 008-korean-localization: Replaced all English UI strings with Korean. "Wishlist" → "맛집" throughout. No i18n framework — direct string replacement.
- 009-fix-my-tab-redirect: Fixed MY tab — `/my` route now renders own profile inline instead of redirecting to `/users/{id}`. MY tab stays highlighted.
- 010-rename-my-tab: Renamed bottom nav "MY" tab to "내정보" for consistent Korean navigation (맛집, 검색, 사람, 내정보).
- 011-restaurant-sharing: Added mutual-follower restaurant recommendation system. Users can recommend restaurants from their own wishlist to mutual followers. New `recommendations` table with RLS, two Postgres functions (`get_mutual_followers`, `get_unread_recommendation_count`). New UI: TopBar with bell-icon badge, RecommendModal, RecommendationCard, `/recommendations` inbox page.
- 013-search-add-sort: Changed search sort from distance-first to relevance-first (`sort=accuracy`). Added star rating selector when adding restaurants from map. Bottom sheet auto-collapses on marker click.
- 014-visited-wishlist: Split restaurant list into "맛집 리스트" (visited, star rating 1-3) and "위시 리스트" (wishlist, no rating). Nullable `star_rating` as discriminator (NULL = wishlist). Two-section layout on main/profile pages, dual add buttons on search (+ for wishlist, ★ for visited), ♡/★ saved indicators.
- 015-global-search: Added global search fallback — when keyword search finds fewer than 5 results within viewport, retries without geographic bounds (nationwide). Map pans/zooms to fit distant results.
- 016-profile-star-ratings: Star ratings (1-3) now visible in read-only mode on all profile pages (`/users/[id]` and `/my`). Uses existing `StarRating` component with `readonly` prop.
- 017-naver-map-import: Added Naver Map bookmark import — paste public share link, server-side fetch via undocumented Naver API, Haversine dedup (50m), bulk insert to Supabase. Background Kakao enrichment (fire-and-forget 202). Import history with batch undo. New routes: `/api/import/naver`, `/api/import/save`, `/api/import/enrich`, `/api/import/history`, `/api/import/batch/[id]`. New page: `/my/import`. 132 unit tests.
- 018-fix-mylist-user-filter: Fixed data isolation bug — 5 read hooks in `src/db/hooks.ts` (`useWishlist`, `useVisitedGrouped`, `useWishlistGrouped`, `useRestaurant`, `useIsWishlisted`) were missing `.eq("user_id", userId)` filters after feature 007 relaxed RLS SELECT policy for social profiles. Hooks now call `supabase.auth.getUser()` internally. 10 unit tests added.
- 019-auth-cache-guard: Added `AuthCacheGuard` component — listens to `onAuthStateChange` and calls `invalidateAll()` on SIGNED_OUT/SIGNED_IN/USER_UPDATED events (not TOKEN_REFRESHED). Prevents stale cache across account switches. Added `.eq("user_id", user.id)` defense-in-depth filters to 4 mutation hooks (`useRemoveRestaurant`, `useUpdateStarRating`, `useMarkAsVisited`, `useMoveToWishlist`). 6 unit tests.
- 020-list-add-notify: Added optimistic UI and toast feedback for add-to-list actions on the search page. `Toast.tsx` replaces `ErrorToast.tsx` with `type: "success" | "error"` prop and configurable auto-dismiss duration. `addingId` state tracks the in-flight card and disables its add buttons with a `…` indicator, preventing duplicate taps. `invalidateByPrefix(prefix)` added to `src/lib/supabase/invalidate.ts` — iterates all listener keys and fires those starting with the given prefix. `invalidateRestaurants()` now calls `invalidateByPrefix("restaurant-status:")` and `invalidateByPrefix("wishlisted-set:")` so any add mutation refreshes all dynamic status-map cache entries. `RestaurantCard` gains `isAdding` prop (`opacity-50 pointer-events-none` on buttons). 151 unit tests.
- 021-map-saved-markers: Display saved restaurants as markers on Kakao map with visual distinction — red circle for search results, blue heart for wishlist, orange star for visited. Custom SVG data URI markers via `kakao.maps.MarkerImage` (28x40px, lazy `btoa()` to avoid SSR issues). `useSavedRestaurantsForMap` hook fetches all saved places for the current user. `mergeMarkers()` utility in `src/lib/merge-markers.ts` deduplicates search results and saved markers by Kakao place ID (saved wins), with viewport filtering via `isInViewport()`. `SavedMarkersToggle` floating button shows/hides saved markers (default: visible). Enhanced info windows: visited shows star rating, wishlist shows "♡ 가고 싶은 곳". `MAP_MARKERS_KEY` cache key integrated into `invalidateRestaurants()`. 13 unit tests.
- fix-naver-integration: Fixed 3 bugs in Naver Map bookmark import — (1) `naver.me` short URLs (307 redirects) were not being resolved; added `resolveNaverShortUrl()` with `redirect: "manual"` to extract the 32-char folder ID from the `Location` header, (2) Naver bookmark API returns 500 from datacenter IPs with minimal headers; fixed by sending browser-like headers (User-Agent, Accept, Accept-Language, Referer), (3) bookmark name parsing checked `displayname` (lowercase, never populated) instead of `name` (always populated); now uses `name > displayName > displayname` fallback chain. Also fixed `folderName` extraction (`resp.folder.name` not `resp.folderName`).
- 022-optimistic-updates: Added optimistic updates to all 4 mutation hooks (`useRemoveRestaurant`, `useUpdateStarRating`, `useMarkAsVisited`, `useMoveToWishlist`) — UI updates instantly before server responds, with snapshot-rollback on error. Extended cache system with `getCache()`, `setCache()`, `subscribeToCache()` in `invalidate.ts`; `use-query.ts` subscribes to cache changes for instant re-render. All mutation hooks now accept `onError` callback and return `{ success, error }`. Error toast feedback on main page and restaurant detail page. Fixed star rating 4/5 bug (DB CHECK constraint updated from 1-3 to 1-5 scale). 188 unit tests.
- 023-kakao-share: Added KakaoTalk sharing — service link share button in `TopBar`, profile share button in `ProfileHeader` (own profile only). `shareService()` and `shareProfile()` in `src/lib/kakao-share.ts` use Kakao JS SDK Feed-type share with clipboard fallback when SDK unavailable. `KakaoScript.tsx` extended to dual-load Maps SDK and JS SDK (separate namespaces: `window.kakao` vs `window.Kakao`). `ShareButton` component handles auth check (guests redirected to `/login`), loading state, and `onResult` callback for toast feedback. TypeScript declarations in `src/types/kakao.d.ts`. 9 unit tests (215 total).
- 024-logout: Added logout button to ProfileHeader on '내 정보' tab (own profile only). `window.confirm()` dialog prevents accidental sign-outs. Calls Supabase `signOut()` → existing `AuthCacheGuard` clears all cached data → redirect to `/login`. Error toast on failure, loading state during sign-out. 6 unit tests (194 total).
- 025-optimistic-tab-updates: Eliminated loading flash on wishlist tab mutations by implementing stale-while-revalidate in `useSupabaseQuery`. Added `hasDataRef` to track first successful fetch — `isLoading` only true on initial fetch (no cached data), stays false during revalidation. Star rating updates, move-to-wishlist, mark-as-visited, and delete operations now show instant UI feedback without flickering. 3 unit tests in `tests/unit/use-query.test.ts` (209 total).
- 026-naver-category-enrichment: Auto-enrich Naver Map imported restaurant categories with Kakao API. Two-tier enrichment: (1) name+distance keyword match within 300m updates `kakao_place_id`, `category`, `place_url`; (2) coordinate-only fallback within 50m updates only `category` (FD6/CE7 category search). Korean suffix-aware name normalization (`stripSuffix()` with two-pass regex: known compounds first, then `[\uAC00-\uD7A3]{1,4}점$`). `searchByCategory()` added to `src/lib/kakao.ts`. `findCategoryByCoordinates()` in `src/lib/enrichment.ts`. Re-enrichment button ("전체 카테고리 다시 매칭") in ImportHistory with idempotent skip guard. `categorized_count` column on `import_batches` with COUNT-only Supabase query. Import history shows `카테고리 N/M` format. 8 unit tests (217 total).
- 027-og-image: Added 1200x630 PNG at `/public/og-image.png` for KakaoTalk share preview. Resolves broken image in KakaoTalk share messages (`kakao-share.ts` references `SERVICE_URL/og-image.png`). Updated `kakao.md` rules with Share API details.
- 028-adjust-map-icons: Changed map markers from teardrop pins (28x40px) to circular icons (20x20px) for better distinction of nearby places. Replaced SVG paths for all 3 marker types (search/red, wishlist/blue, visited/orange). Added `KakaoPoint` type and `Point` constructor for center anchor offset. Lazy `btoa()` cache preserved.
- 029-address-enrichment: Added road address matching as Tier 1.5 in the Naver→Kakao enrichment pipeline. When name matching (Tier 1) fails, `findKakaoMatchByAddress()` compares normalized Korean road addresses within 500m — government-standardized addresses are high-confidence, so wider radius is safe. `normalizeAddress()` strips administrative suffixes (특별시, 광역시, 특별자치시, 특별자치도). Checks both `road_address_name` and `address_name` (jibun) from Kakao results. Three-tier pipeline: name match (300m, all fields) → address match (500m, all fields) → coordinate fallback (50m, category only). 12 new tests (239 total).
